# Autonomous Agent Container
# Provides a complete environment for running AI agents with tmux, development tools, and Claude integration

FROM ubuntu:22.04

# Prevent interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC

# Install system dependencies
RUN apt-get update && apt-get install -y \
    tmux \
    curl \
    wget \
    git \
    jq \
    python3 \
    python3-pip \
    nodejs \
    npm \
    bash \
    openssh-client \
    ca-certificates \
    supervisor \
    && rm -rf /var/lib/apt/lists/*

# Install Python packages for agent functionality
RUN pip3 install \
    requests \
    anthropic \
    asyncio \
    aiohttp \
    redis \
    python-dotenv

# Create agent user and workspace
RUN useradd -m -s /bin/bash agent && \
    mkdir -p /workspace && \
    chown -R agent:agent /workspace

# Copy agent scripts and utilities
COPY containers/agent-scripts/ /usr/local/bin/
COPY send-claude-message.sh /usr/local/bin/
COPY schedule_with_note.sh /usr/local/bin/
COPY tmux_utils.py /usr/local/bin/

# Make scripts executable
RUN chmod +x /usr/local/bin/*.sh

# Set up tmux configuration for optimal agent operation
COPY containers/tmux.conf /home/agent/.tmux.conf
RUN chown agent:agent /home/agent/.tmux.conf

# Configure supervisor for managing tmux and agent processes
COPY containers/supervisord.conf /etc/supervisor/conf.d/agent.conf

# Set up environment variables
ENV AGENT_TYPE=""
ENV PROJECT_NAME=""
ENV PROJECT_PATH="/workspace"
ENV HUB_API_URL="http://api-gateway:80"
ENV REDIS_URL="redis://redis:6379"

# Create entrypoint script
COPY containers/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Switch to agent user
USER agent
WORKDIR /workspace

# Expose ports for communication (if needed)
EXPOSE 22222

# Start with entrypoint that initializes the agent
ENTRYPOINT ["/entrypoint.sh"]